<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Solar System V26: MOBILE TOUCH</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Segoe UI', sans-serif; cursor: none; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }

        /* --- HUD (Bottom) --- */
        .hud-bottom {
            position: absolute; bottom: 30px; width: 100%;
            display: flex; justify-content: center;
            flex-direction: column; align-items: center; gap: 10px;
            transition: bottom 0.3s; pointer-events: none;
        }
        
        .hud-panel {
            background: rgba(10, 15, 20, 0.85);
            border: 1px solid rgba(100, 200, 255, 0.3);
            border-radius: 40px; padding: 10px 30px;
            backdrop-filter: blur(15px); color: #fff;
            display: flex; gap: 20px; align-items: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            transition: all 0.3s; transform-origin: bottom center;
            pointer-events: auto; 
        }
        
        .hud-panel.mouse-mode { border-color: #ffaa00; }
        .stat-label { font-size: 9px; color: #888; letter-spacing: 2px; text-transform: uppercase; }
        .stat-value { font-size: 14px; font-weight: 700; color: #fff; min-width: 100px; text-shadow: 0 0 10px rgba(255,255,255,0.8); }

        /* --- SIDE PANEL --- */
        #side-panel {
            position: absolute; right: -350px; top: 0; height: 100%; width: 300px; 
            background: linear-gradient(to right, rgba(0,0,0,0.9), rgba(0,0,0,0.98));
            border-left: 1px solid rgba(0, 210, 255, 0.3);
            padding: 80px 30px 40px 30px; color: white; box-sizing: border-box;
            transition: transform 0.4s cubic-bezier(0.22, 1, 0.36, 1);
            display: flex; flex-direction: column; justify-content: center;
            pointer-events: auto; z-index: 20;
        }
        #side-panel.active { transform: translateX(-350px); }

        .planet-title { font-size: 42px; font-weight: 300; margin: 0 0 5px 0; letter-spacing: 4px; color: #00d2ff; text-shadow: 0 0 20px rgba(0, 210, 255, 0.4); }
        .planet-desc { font-size: 13px; color: #bbb; line-height: 1.5; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .data-row { display: flex; justify-content: space-between; border-bottom: 1px solid #222; padding: 10px 0; }
        .data-key { color: #666; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; }
        .data-val { font-family: 'Courier New', monospace; font-size: 14px; color: #fff; text-shadow: 0 0 5px rgba(255,255,255,0.3); }

        .gesture-hint {
            margin-top: auto; font-size: 10px; color: #888; letter-spacing: 1px;
            display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: center;
        }
        .hint-icon { padding: 3px 6px; border: 1px solid rgba(255,255,255,0.2); border-radius: 3px; background: rgba(255,255,255,0.05); }

        /* --- TOGGLE & EXIT BUTTONS --- */
        #panel-toggle {
            position: absolute; top: 25px; right: 25px; width: 45px; height: 45px;
            z-index: 100; cursor: pointer; pointer-events: auto; display: none;
            flex-direction: column; justify-content: center; align-items: flex-end; gap: 6px;
            background: rgba(0,0,0,0.5); border-radius: 50%; padding-right: 10px; border: 1px solid rgba(255,255,255,0.1);
        }
        .bar { height: 2px; background-color: #00d2ff; box-shadow: 0 0 8px #00d2ff; transition: all 0.3s ease; }
        .bar:nth-child(1) { width: 24px; } .bar:nth-child(2) { width: 16px; } .bar:nth-child(3) { width: 24px; }
        #panel-toggle.open .bar:nth-child(1) { transform: rotate(45deg) translate(5px, 6px); width: 24px; }
        #panel-toggle.open .bar:nth-child(2) { opacity: 0; }
        #panel-toggle.open .bar:nth-child(3) { transform: rotate(-45deg) translate(5px, -6px); width: 24px; }

        #exit-btn {
            position: absolute; top: 25px; left: 25px; width: 45px; height: 45px;
            z-index: 100; cursor: pointer; pointer-events: auto; display: none;
            justify-content: center; align-items: center; color: #00d2ff;
            background: rgba(0,0,0,0.5); border-radius: 50%; border: 1px solid rgba(255,255,255,0.1);
            font-weight: bold; font-size: 20px;
        }

        @media (max-width: 768px) {
            .hud-bottom { bottom: 20px; }
            .hud-panel { padding: 8px 15px; gap: 12px; border-radius: 20px; width: auto; max-width: 90%; }
            .hud-divider { display: none; }
            .stat-label { font-size: 8px; letter-spacing: 1px; margin-bottom: 2px; }
            .stat-value { font-size: 11px; min-width: auto; text-align: center; }
            #side-panel { width: 100%; right: -100%; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(10px); border-left: none; padding-top: 100px; padding-bottom: 100px; }
            #side-panel.active { transform: translateX(-100%); }
            .planet-title { font-size: 32px; text-align: center; }
            #panel-toggle { top: 20px; right: 20px; }
            #exit-btn { top: 20px; left: 20px; }
        }

        #finger-cursor {
            position: absolute; width: 60px; height: 60px;
            border: 2px solid rgba(255, 255, 255, 0.4); border-radius: 50%;
            transform: translate(-50%, -50%); z-index: 20;
            display: flex; align-items: center; justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            transition: border-color 0.2s, background-color 0.2s, opacity 0.3s;
            box-shadow: 0 0 15px rgba(255,255,255,0.2); pointer-events: none; opacity: 0;
        }
        #finger-cursor.locked { border-color: #00ffaa; background: rgba(0, 255, 170, 0.2); animation: lockPulse 1.5s infinite ease-in-out; }
        @keyframes lockPulse { 0% { box-shadow: 0 0 15px rgba(0, 255, 170, 0.4); transform: translate(-50%, -50%) scale(1.1); } 50% { box-shadow: 0 0 35px rgba(0, 255, 170, 0.8); transform: translate(-50%, -50%) scale(1.15); } 100% { box-shadow: 0 0 15px rgba(0, 255, 170, 0.4); transform: translate(-50%, -50%) scale(1.1); } }
        
        .progress-ring { position: absolute; width: 100%; height: 100%; transform: rotate(-90deg); }
        .progress-ring__circle { transition: stroke-dashoffset 0.1s linear; transform-origin: 50% 50%; stroke: #00ffaa; }
        #input_video { position: absolute; opacity: 0; pointer-events: none; z-index: -1; width: 640px; height: 480px;}
        
        #loader {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 999;
            transition: opacity 0.5s ease-out; pointer-events: none;
        }
        #shockwave-ring {
            position: absolute; top: 50%; left: 50%; width: 10px; height: 10px;
            border: 10px solid #fff; border-radius: 50%; transform: translate(-50%, -50%); opacity: 0; pointer-events: none; z-index: 50;
        }
        #mouse-badge { display: none; background: #ffaa00; color: #000; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 8px; margin-left: 5px; vertical-align: middle;}
    </style>
</head>
<body>

    <div id="loader">
        <div style="color: white; letter-spacing: 8px; font-weight: 300; font-size: 24px;">SYSTEM INITIALIZING</div>
        <div id="loader-status" style="color: #666; font-size: 12px; margin-top:10px;">ESTABLISHING UPLINK...</div>
    </div>
    
    <div id="shockwave-ring"></div>

    <div id="ui-layer">
        <div id="finger-cursor">
            <svg class="progress-ring" width="60" height="60">
                <circle class="progress-ring__circle" stroke-width="4" fill="transparent" r="26" cx="30" cy="30" stroke-dasharray="163" stroke-dashoffset="163" />
            </svg>
        </div>

        <div class="hud-bottom">
            <div class="hud-panel" id="main-hud">
                <div>
                    <div class="stat-label">Mode</div>
                    <div class="stat-value" id="mode-val">SYSTEM VIEW</div>
                </div>
                <div class="hud-divider" style="width: 1px; height: 20px; background: rgba(255,255,255,0.2);"></div>
                <div>
                    <div class="stat-label">Input</div>
                    <div class="stat-value" id="input-source">
                        <span id="source-text">SCANNING</span>
                        <span id="mouse-badge">MOUSE</span>
                    </div>
                </div>
                <div class="hud-divider" style="width: 1px; height: 20px; background: rgba(255,255,255,0.2);"></div>
                <div>
                    <div class="stat-label">Target</div>
                    <div class="stat-value" id="target-val" style="color: #00ffaa;">WAITING</div>
                </div>
            </div>
        </div>

        <!-- EXIT BUTTON (Mobile Only) -->
        <div id="exit-btn">✕</div>

        <!-- HAMBURGER BUTTON -->
        <div id="panel-toggle">
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
        </div>

        <div id="side-panel">
            <h1 class="planet-title" id="p-name">EARTH</h1>
            <p class="planet-desc" id="p-desc">Description here.</p>
            <div class="data-row"><span class="data-key">Diameter</span><span class="data-val" id="p-diam">0</span></div>
            <div class="data-row"><span class="data-key">Temp</span><span class="data-val" id="p-temp">0</span></div>
            <div class="data-row"><span class="data-key">Gravity</span><span class="data-val" id="p-grav">0</span></div>
            <div class="data-row"><span class="data-key">Satellites</span><span class="data-val" id="p-moons">0</span></div>
            
            <div class="gesture-hint" id="gesture-hints">
                <span class="hint-icon">PINCH</span> SHRINK
                <span class="hint-icon" style="margin-left:10px;">OPEN</span> FLY IN
                <span class="hint-icon" style="margin-left:10px;">PUSH</span> EXIT
            </div>
        </div>
    </div>

    <video id="input_video" playsinline></video>

    <!-- SHADERS -->
    <script type="x-shader/x-vertex" id="planetVertex">
        uniform float uTime; uniform float uScale; attribute float aRandom; attribute float aSize; attribute vec3 aColor; 
        attribute float aIsMoon; attribute float aOrbitRad; attribute float aOrbitSpeed; attribute float aOrbitOffset;
        varying float vAlpha; varying vec3 vColor;
        void main() {
            vec3 basePos = position;
            if(aIsMoon > 0.5) { float angle = aOrbitOffset + uTime * aOrbitSpeed * 0.2; basePos.x += cos(angle) * aOrbitRad; basePos.z += sin(angle) * aOrbitRad; }
            vec3 pos = basePos * uScale; vec4 mvPosition = modelViewMatrix * vec4(pos, 1.0); gl_Position = projectionMatrix * mvPosition;
            float twinkle = smoothstep(-1.0, 1.0, sin(uTime * 3.0 + aRandom * 25.0));
            float finalSize = aSize * (0.8 + 0.4 * twinkle); 
            float zoomDamp = uScale > 2.0 ? 1.0 + (uScale * 0.1) : 1.0;
            gl_PointSize = finalSize * (3000.0 / -mvPosition.z) * zoomDamp;
            vAlpha = 0.5 + 0.5 * twinkle; vColor = aColor; 
        }
    </script>
    <script type="x-shader/x-fragment" id="planetFragment">
        uniform float uScale; varying float vAlpha; varying vec3 vColor;
        void main() {
            float r = length(gl_PointCoord - vec2(0.5)); if (r > 0.5) discard;
            float glow = pow(1.0 - (r * 2.0), 2.0); 
            float density = uScale > 5.0 ? 1.0 / (uScale * 0.3) : 1.0;
            gl_FragColor = vec4(vColor * 2.5 + vec3(1.0) * pow(glow, 4.0), vAlpha * glow * density);
        }
    </script>
    <script type="x-shader/x-vertex" id="sunVertex">
        uniform float uTime; attribute float aRandom; varying float vAlpha; varying vec3 vPos;
        void main() { vPos = position; vec4 mvPosition = modelViewMatrix * vec4(position, 1.0); gl_Position = projectionMatrix * mvPosition; gl_PointSize = (25.0 + aRandom * 10.0) * (300.0 / -mvPosition.z); vAlpha = 0.95; }
    </script>
    <script type="x-shader/x-fragment" id="sunFragment">
        uniform vec3 uColorCore; uniform vec3 uColorRim; uniform float uTime; varying float vAlpha; varying vec3 vPos;
        float random (in vec2 st) { return fract(sin(dot(st.xy, vec2(12.9898,78.233)))* 43758.5453123); }
        float noise (in vec2 st) { vec2 i = floor(st); vec2 f = fract(st); vec2 u = f * f * (3.0 - 2.0 * f); return mix(mix(random(i), random(i + vec2(1.0, 0.0)), u.x), mix(random(i + vec2(0.0, 1.0)), random(i + vec2(1.0, 1.0)), u.x), u.y); }
        void main() { float r = length(gl_PointCoord - vec2(0.5)); if (r > 0.5) discard; float glow = pow(1.0 - (r * 2.0), 1.8); float n = noise(vPos.xy * 0.1 + uTime * 0.3); vec3 surfColor = mix(uColorCore, uColorRim, n); gl_FragColor = vec4(surfColor * 3.0 + vec3(1.0, 1.0, 0.8) * pow(glow, 3.0), vAlpha * glow); }
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils@0.6/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <script>
        // --- MOBILE DETECTION & SCALING ---
        const isMobile = window.innerWidth < 768;
        
        // Mobile Scaling: Sun is smaller (0.6x), Planets are Bigger (1.8x)
        const SUN_RADIUS = isMobile ? 30 : 45; 
        const PLANET_SCALE_MOD = isMobile ? 1.8 : 1.0; 

        const PLANET_DATA = [
            { name: "MERCURY", color: 0xAAAAAA, pColor: "#aaaaaa", dist: 100, size: 4.5, moons: [], desc: "The smallest planet.", realDia: "4,879 km", temp: "167°C", grav: "3.7 m/s²" },
            { name: "VENUS", color: 0xE3BB76, pColor: "#ffcc66", dist: 160, size: 6.0, moons: [], desc: "Hottest planet.", realDia: "12,104 km", temp: "464°C", grav: "8.87 m/s²" },
            { name: "EARTH", color: 0x2233FF, pColor: "#0088ff", dist: 220, size: 6.5, moons: [{ name: "Moon", size: 12.0, color: "#dddddd", dist: 120 }], desc: "Our home.", realDia: "12,742 km", temp: "15°C", grav: "9.8 m/s²" },
            { name: "MARS", color: 0xFF4500, pColor: "#ff4422", dist: 280, size: 5.0, moons: [{ name: "Phobos", size: 4.0, color: "#aa8888", dist: 80 }, { name: "Deimos", size: 3.0, color: "#886666", dist: 110 }], desc: "The Red Planet.", realDia: "6,779 km", temp: "-65°C", grav: "3.71 m/s²" },
            { name: "JUPITER", color: 0xD9A066, pColor: "#d9a066", dist: 400, size: 14.0, moons: [{ name: "Io", size: 5.0, color: "#ffdd00", dist: 160 }, { name: "Europa", size: 4.5, color: "#ffffff", dist: 200 }, { name: "Ganymede", size: 6.0, color: "#aaaaaa", dist: 260 }, { name: "Callisto", size: 5.8, color: "#777777", dist: 320 }], desc: "Gas Giant.", realDia: "139,820 km", temp: "-110°C", grav: "24.79 m/s²" },
            { name: "SATURN", color: 0xF4D03F, pColor: "#ffee88", dist: 520, size: 12.0, rings: true, moons: [{ name: "Titan", size: 6.5, color: "#ffaa00", dist: 220 }, { name: "Enceladus", size: 3.0, color: "#ccffff", dist: 150 }, { name: "Rhea", size: 4.0, color: "#eeeeee", dist: 280 }], desc: "Ringed Jewel.", realDia: "116,460 km", temp: "-140°C", grav: "10.44 m/s²" },
            { name: "URANUS", color: 0x4FD0E7, pColor: "#66ffff", dist: 640, size: 9.0, rings: true, moons: [{ name: "Titania", size: 4.0, color: "#cccccc", dist: 180 }, { name: "Oberon", size: 4.0, color: "#bbbbbb", dist: 240 }], desc: "Ice Giant.", realDia: "50,724 km", temp: "-195°C", grav: "8.69 m/s²" },
            { name: "NEPTUNE", color: 0x2E67F8, pColor: "#4466ff", dist: 760, size: 8.5, moons: [{ name: "Triton", size: 5.5, color: "#ffcccc", dist: 160 }], desc: "Windy World.", realDia: "49,244 km", temp: "-200°C", grav: "11.15 m/s²" }
        ];

        const STATE = {
            mode: 'SOLAR', targetIndex: -1, hoverIndex: -1, selectionProgress: 0,
            particleScale: 1.0, inputMethod: 'NONE', lastModeChange: 0,
            lastHandSize: 0, isExiting: false, rotationY: 0, rotationVelocity: 0, isDragging: false, lastInputX: 0
        };
        
        const cursorSmoothing = { x: 0.5, y: 0.5 };
        const smoothingFactor = 0.15;
        const scene = new THREE.Scene(); scene.fog = new THREE.FogExp2(0x000000, 0.0002);
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 10000);
        camera.position.set(0, 300, 850); camera.lookAt(0, 0, 0);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, powerPreference: "high-performance" });
        renderer.setSize(window.innerWidth, window.innerHeight); renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.body.appendChild(renderer.domElement);
        scene.add(new THREE.AmbientLight(0xffffff, 0.5)); scene.add(new THREE.PointLight(0xffaa00, 4.0, 2000));
        
        const solarGroup = new THREE.Group(); solarGroup.position.x = -100; scene.add(solarGroup);
        // SCALED SUN
        const sunGeo = new THREE.SphereGeometry(SUN_RADIUS, 64, 64); 
        const sunMat = new THREE.ShaderMaterial({ uniforms: { uTime: { value: 0 }, uColorCore: { value: new THREE.Color("#ffcc00") }, uColorRim: { value: new THREE.Color("#ff4400") } }, vertexShader: document.getElementById('sunVertex').textContent, fragmentShader: document.getElementById('sunFragment').textContent, transparent: true, depthWrite: false, blending: THREE.AdditiveBlending });
        const sunParticles = new THREE.Points(sunGeo, sunMat); solarGroup.add(sunParticles);

        const planetMeshes = []; const hitMeshes = [];
        PLANET_DATA.forEach((p, i) => {
            const container = new THREE.Group();
            
            // APPLY MOBILE SCALING
            const modSize = p.size * PLANET_SCALE_MOD;

            const mesh = new THREE.Mesh(new THREE.SphereGeometry(modSize, 32, 32), new THREE.MeshStandardMaterial({ color: p.color, roughness: 0.6, metalness: 0.2 }));
            if(p.rings) { const r = new THREE.Mesh(new THREE.RingGeometry(modSize*1.4, modSize*2.2, 64), new THREE.MeshBasicMaterial({ color: 0xcccccc, side: THREE.DoubleSide, transparent: true, opacity: 0.5 })); r.rotation.x = Math.PI/2.2; mesh.add(r); }
            container.add(mesh);
            
            // Hitbox is also scaled
            const hitMesh = new THREE.Mesh(new THREE.SphereGeometry(modSize * 4.0, 16, 16), new THREE.MeshBasicMaterial({ visible: false })); 
            hitMesh.userData = { id: i, name: p.name };
            container.add(hitMesh); hitMeshes.push(hitMesh);
            
            const angle = (i * (Math.PI * 1.2) / (PLANET_DATA.length - 1)) - (Math.PI * 0.6);
            container.position.set(p.dist * Math.sin(angle), 0, p.dist * Math.cos(angle) * 0.3); solarGroup.add(container); planetMeshes.push(container);
        });
        scene.add(new THREE.Points(new THREE.BufferGeometry().setAttribute('position', new THREE.BufferAttribute(new Float32Array(10000 * 3).map(()=>(Math.random()-0.5)*4000), 3)), new THREE.PointsMaterial({color:0xffffff, size:1.5, transparent:true, opacity:0.5})));

        const particleCount = 100000; const pGeo = new THREE.BufferGeometry();
        const pPos = new Float32Array(particleCount * 3); const pRnd = new Float32Array(particleCount); const pSize = new Float32Array(particleCount); const pColor = new Float32Array(particleCount * 3); const pIsMoon = new Float32Array(particleCount); const pOrbitRad = new Float32Array(particleCount); const pOrbitSpeed = new Float32Array(particleCount); const pOrbitOffset = new Float32Array(particleCount);
        for(let i=0; i<particleCount; i++) { pPos[i*3]=0; pRnd[i]=Math.random(); pSize[i]=1.0; pIsMoon[i]=0; }
        pGeo.setAttribute('position', new THREE.BufferAttribute(pPos, 3)); pGeo.setAttribute('aRandom', new THREE.BufferAttribute(pRnd, 1)); pGeo.setAttribute('aSize', new THREE.BufferAttribute(pSize, 1)); pGeo.setAttribute('aColor', new THREE.BufferAttribute(pColor, 3)); pGeo.setAttribute('aIsMoon', new THREE.BufferAttribute(pIsMoon, 1)); pGeo.setAttribute('aOrbitRad', new THREE.BufferAttribute(pOrbitRad, 1)); pGeo.setAttribute('aOrbitSpeed', new THREE.BufferAttribute(pOrbitSpeed, 1)); pGeo.setAttribute('aOrbitOffset', new THREE.BufferAttribute(pOrbitOffset, 1));
        const pMat = new THREE.ShaderMaterial({ uniforms: { uTime: { value: 0 }, uScale: { value: 1.0 } }, vertexShader: document.getElementById('planetVertex').textContent, fragmentShader: document.getElementById('planetFragment').textContent, transparent: true, depthWrite: false, blending: THREE.AdditiveBlending });
        const particleSystem = new THREE.Points(pGeo, pMat); scene.add(particleSystem); particleSystem.visible = false;

        function generatePlanetParticles(index) {
            const data = PLANET_DATA[index]; const hasRings = data.rings; const moons = data.moons; let particlesUsed = 0; const planetColor = new THREE.Color(data.pColor);
            moons.forEach(moon => {
                const particlesPerMoon = 3000; const moonColor = new THREE.Color(moon.color); const orbitSpeed = (Math.random() > 0.5 ? 1 : -1) * (0.3 + Math.random() * 0.2); const orbitOffset = Math.random() * Math.PI * 2;
                for(let i=0; i<particlesPerMoon; i++) {
                    const idx = particlesUsed + i; const theta = Math.random() * Math.PI * 2; const phi = Math.acos(2 * Math.random() - 1); const r = (moon.size * Math.cbrt(Math.random())) * 10.0; 
                    pPos[idx*3] = r * Math.sin(phi) * Math.cos(theta); pPos[idx*3+1] = r * Math.sin(phi) * Math.sin(theta); pPos[idx*3+2] = r * Math.cos(phi);
                    pColor[idx*3] = moonColor.r; pColor[idx*3+1] = moonColor.g; pColor[idx*3+2] = moonColor.b; pIsMoon[idx] = 1.0; pOrbitRad[idx] = moon.dist; pOrbitSpeed[idx] = orbitSpeed; pOrbitOffset[idx] = orbitOffset;
                } particlesUsed += particlesPerMoon;
            });
            for(let i=particlesUsed; i<particleCount; i++) {
                let x,y,z, size; const r = Math.random(); pIsMoon[i] = 0.0; pColor[i*3] = planetColor.r; pColor[i*3+1] = planetColor.g; pColor[i*3+2] = planetColor.b; const scalar = 12.0; 
                if(hasRings && r < 0.65) { const angle = Math.random() * Math.PI * 2; const dist = (Math.random() > 0.4 ? 14 + Math.random() * 9 : 10 + Math.random() * 2) * scalar; x = Math.cos(angle)*dist; z = Math.sin(angle)*dist; y = (Math.random()-0.5)*3.0; size = Math.random() * 2.5; } 
                else if ((hasRings && r < 0.80) || (!hasRings && r < 0.70)) { const theta = Math.random() * Math.PI * 2; const phi = Math.acos((Math.random() * 2) - 1); const rad = 7.5 * scalar; x = rad * Math.sin(phi) * Math.cos(theta); y = rad * Math.sin(phi) * Math.sin(theta); z = rad * Math.cos(phi); size = Math.random() * 3.0; } 
                else { const theta = Math.random() * Math.PI * 2; const phi = Math.acos((Math.random() * 2) - 1); const rad = Math.random() * 60 * scalar; x = rad * Math.sin(phi) * Math.cos(theta); y = rad * Math.sin(phi) * Math.sin(theta); z = rad * Math.cos(phi); size = Math.random(); }
                
                // Scale particles on mobile too so Detail View isn't tiny
                size *= PLANET_SCALE_MOD;

                const tilt = 0.3; const ty = y; y = y*Math.cos(tilt)-z*Math.sin(tilt); z = ty*Math.sin(tilt)+z*Math.cos(tilt); pPos[i*3] = x; pPos[i*3+1] = y; pPos[i*3+2] = z; pSize[i] = size;
            }
            pGeo.attributes.position.needsUpdate = true; pGeo.attributes.aColor.needsUpdate = true; pGeo.attributes.aIsMoon.needsUpdate = true; pGeo.attributes.aOrbitRad.needsUpdate = true; pGeo.attributes.aOrbitSpeed.needsUpdate = true; pGeo.attributes.aOrbitOffset.needsUpdate = true; pGeo.attributes.aSize.needsUpdate = true;
        }

        const raycaster = new THREE.Raycaster(); const pointer = new THREE.Vector2(); raycaster.params.Points.threshold = 10;
        const cursor = document.getElementById('finger-cursor'); const ringCircle = document.querySelector('.progress-ring__circle'); const hudTarget = document.getElementById('target-val');
        
        // --- UI TOGGLE LOGIC ---
        const panelToggle = document.getElementById('panel-toggle');
        const sidePanel = document.getElementById('side-panel');
        const exitBtn = document.getElementById('exit-btn');
        
        panelToggle.addEventListener('click', (e) => { e.stopPropagation(); sidePanel.classList.toggle('active'); panelToggle.classList.toggle('open'); });
        exitBtn.addEventListener('click', (e) => { e.stopPropagation(); triggerPushExit(); });

        function hideLoader() { const l = document.getElementById('loader'); if(l.style.opacity!=='0'){ l.style.opacity = 0; setTimeout(() => { l.style.display = 'none'; }, 500); } }

        function updateCursor(rawX, rawY) {
            cursorSmoothing.x += (rawX - cursorSmoothing.x) * smoothingFactor; cursorSmoothing.y += (rawY - cursorSmoothing.y) * smoothingFactor;
            cursor.style.left = (cursorSmoothing.x * window.innerWidth) + 'px'; cursor.style.top = (cursorSmoothing.y * window.innerHeight) + 'px';
            pointer.x = (cursorSmoothing.x * 2) - 1; pointer.y = -(cursorSmoothing.y * 2) + 1;
            const now = Date.now();
            if(STATE.mode === 'SOLAR') { checkIntersection(); } 
            else if(STATE.mode === 'DETAIL') {
                if(STATE.isDragging) { const deltaX = cursorSmoothing.x - STATE.lastInputX; STATE.rotationVelocity = deltaX * 5.0; STATE.rotationY += STATE.rotationVelocity; }
                STATE.lastInputX = cursorSmoothing.x;
            }
        }

        function activateTouchMode() {
            if(STATE.inputMethod === 'TOUCH') return;
            STATE.inputMethod = 'TOUCH'; 
            document.getElementById('source-text').innerText = "TOUCH COMMAND"; 
            document.getElementById('mouse-badge').style.display = "inline-block"; 
            document.getElementById('mouse-badge').innerText = "TOUCH";
            document.getElementById('mouse-badge').style.background = "#00d2ff";
            document.getElementById('main-hud').classList.add('mouse-mode'); 
            document.getElementById('loader-status').innerText = "CAMERA ACCESS DENIED. TOUCH ENABLED.";
            document.getElementById('gesture-hints').innerHTML = `<span class="hint-icon">PINCH</span> ZOOM <span class="hint-icon" style="margin-left:10px;">DRAG</span> ROTATE <span class="hint-icon" style="margin-left:10px;">BTN</span> EXIT`;
            
            setTimeout(hideLoader, 1500); cursor.style.opacity = 0; // Hide cursor on touch, use finger

            // TOUCH LISTENERS
            let initialPinchDist = 0;
            
            window.addEventListener('touchstart', (e) => {
                if(e.touches.length === 1) {
                    STATE.isDragging = true;
                    STATE.lastInputX = e.touches[0].clientX / window.innerWidth;
                    cursorSmoothing.x = STATE.lastInputX; 
                    // Raycast for tap selection
                    updateCursor(e.touches[0].clientX / window.innerWidth, e.touches[0].clientY / window.innerHeight);
                    if(STATE.mode === 'SOLAR' && STATE.hoverIndex !== -1) { enterDetailView(STATE.hoverIndex); }
                } else if (e.touches.length === 2) {
                    initialPinchDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                }
            }, {passive: false});

            window.addEventListener('touchmove', (e) => {
                e.preventDefault(); // Stop scrolling
                if(STATE.mode === 'DETAIL' && e.touches.length === 2) {
                    const dist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                    const delta = dist - initialPinchDist;
                    STATE.particleScale += delta * 0.005;
                    STATE.particleScale = Math.max(0.1, Math.min(STATE.particleScale, 5.0));
                    initialPinchDist = dist;
                } else if(e.touches.length === 1) {
                    updateCursor(e.touches[0].clientX / window.innerWidth, e.touches[0].clientY / window.innerHeight);
                }
            }, {passive: false});

            window.addEventListener('touchend', () => { STATE.isDragging = false; });
        }

        function activateMouseMode() {
            if(isMobile) { activateTouchMode(); return; } // Redirect phones to touch mode
            if(STATE.inputMethod === 'MOUSE') return;
            STATE.inputMethod = 'MOUSE'; document.getElementById('source-text').innerText = "MANUAL"; document.getElementById('mouse-badge').style.display = "inline-block"; document.getElementById('main-hud').classList.add('mouse-mode'); document.getElementById('loader-status').innerText = "CAMERA DENIED";
            document.getElementById('gesture-hints').innerHTML = `<span class="hint-icon">SCROLL</span> ZOOM <span class="hint-icon" style="margin-left:10px;">DRAG</span> ROTATE <span class="hint-icon" style="margin-left:10px;">R-CLICK</span> EXIT`;
            setTimeout(hideLoader, 1500); cursor.style.opacity = 1;
            window.addEventListener('mousemove', (e) => { updateCursor(e.clientX / window.innerWidth, e.clientY / window.innerHeight); });
            window.addEventListener('mousedown', (e) => {
                if(e.button === 0) { STATE.isDragging = true; STATE.lastInputX = cursorSmoothing.x; if(STATE.mode === 'SOLAR' && STATE.hoverIndex !== -1) enterDetailView(STATE.hoverIndex); }
                if(e.button === 2 && STATE.mode === 'DETAIL') triggerPushExit();
            });
            window.addEventListener('mouseup', () => { STATE.isDragging = false; });
            window.addEventListener('wheel', (e) => { if(STATE.mode === 'DETAIL') { const zoomDir = e.deltaY > 0 ? -1 : 1; STATE.particleScale += zoomDir * 0.1; STATE.particleScale = Math.max(0.1, Math.min(STATE.particleScale, 5.0)); } });
            window.addEventListener('contextmenu', e => e.preventDefault());
        }

        const videoElement = document.getElementById('input_video');
        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/${file}`});
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
        hands.onResults(results => {
            if(STATE.inputMethod === 'MOUSE' || STATE.inputMethod === 'TOUCH') return;
            hideLoader(); STATE.inputMethod = 'HAND'; document.getElementById('source-text').innerText = "NEURAL UPLINK";
            if(results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                cursor.style.opacity = 1; const lm = results.multiHandLandmarks[0]; const index = lm[8]; const thumb = lm[4]; const middleMCP = lm[9]; const wrist = lm[0];
                updateCursor(1 - index.x, index.y);
                if(STATE.mode === 'DETAIL') {
                    if(Date.now() - STATE.lastModeChange < 1500) { STATE.lastHandSize = Math.hypot(middleMCP.x - wrist.x, middleMCP.y - wrist.y); return; }
                    const handSize = Math.hypot(middleMCP.x - wrist.x, middleMCP.y - wrist.y); const pinchDist = Math.hypot(thumb.x - index.x, thumb.y - index.y); let normPinch = Math.min(1.0, pinchDist / handSize); 
                    STATE.isDragging = (normPinch < 0.2); 
                    const zVelocity = handSize - STATE.lastHandSize; STATE.lastHandSize = handSize;
                    if(zVelocity > 0.05 && normPinch > 0.4 && !STATE.isExiting) triggerPushExit();
                    if(!STATE.isExiting) { let targetScale = 1.0; if(normPinch < 0.25) targetScale = 0.4 + (normPinch * 3.0); else targetScale = 1.0 + ((normPinch - 0.25) * 10.0); STATE.particleScale += (targetScale - STATE.particleScale) * 0.1; }
                }
            } else { cursor.style.opacity = 0; STATE.isDragging = false; if(STATE.mode === 'SOLAR') { if(STATE.selectionProgress > 0) { STATE.selectionProgress -= 0.02; applyProgressVisuals(); } else resetSelection(); } }
        });
        const cameraUtils = new Camera(videoElement, { onFrame: async () => { await hands.send({image: videoElement}); }, width: 640, height: 480 }); 
        navigator.mediaDevices.getUserMedia({ video: true }).then(() => { cameraUtils.start().catch(err => { console.error(err); activateMouseMode(); }); }).catch(err => { console.warn(err); activateMouseMode(); });

        function triggerPushExit() {
            STATE.isExiting = true; const ring = document.getElementById('shockwave-ring');
            gsap.fromTo(ring, { opacity: 1, scale: 0.1, borderWidth: 10 }, { opacity: 0, scale: 5.0, borderWidth: 0, duration: 0.6, ease: "power2.out" });
            exitDetailView();
        }
        function checkIntersection() {
            raycaster.setFromCamera(pointer, camera); const intersects = raycaster.intersectObjects(hitMeshes);
            if (intersects.length > 0) { const idx = intersects[0].object.userData.id; if (STATE.hoverIndex !== idx) { STATE.hoverIndex = idx; hudTarget.innerText = intersects[0].object.userData.name; cursor.classList.add('locked'); } STATE.selectionProgress += 0.04; } 
            else { STATE.selectionProgress -= 0.005; if(STATE.selectionProgress <= 0) resetSelection(); }
            STATE.selectionProgress = Math.max(0, Math.min(1, STATE.selectionProgress)); applyProgressVisuals(); ringCircle.style.strokeDashoffset = 163 - (STATE.selectionProgress * 163);
            if (STATE.inputMethod === 'HAND' && STATE.selectionProgress >= 1.0 && STATE.mode === 'SOLAR') enterDetailView(STATE.hoverIndex);
        }
        function applyProgressVisuals() { const p = STATE.selectionProgress; sunParticles.scale.setScalar(1.0 - p); planetMeshes.forEach((mesh, i) => { if(i === STATE.hoverIndex) mesh.scale.setScalar(1.0 + (p * 1.5)); else mesh.scale.setScalar(Math.max(0, 1.0 - p)); }); }
        function resetSelection() { STATE.hoverIndex = -1; STATE.selectionProgress = 0; hudTarget.innerText = "WAITING"; cursor.classList.remove('locked'); ringCircle.style.strokeDashoffset = 163; sunParticles.scale.setScalar(1); planetMeshes.forEach(mesh => mesh.scale.setScalar(1)); }
        
        function enterDetailView(index) {
            STATE.mode = 'DETAIL'; STATE.lastModeChange = Date.now(); STATE.targetIndex = index; STATE.isExiting = false;
            document.getElementById('mode-val').innerText = "HOLOGRAPHIC"; cursor.classList.remove('locked'); 
            generatePlanetParticles(index); particleSystem.visible = true; STATE.particleScale = 0;
            gsap.to(STATE, { particleScale: 1.0, duration: 1.5, ease: "back.out(1.0)" });
            solarGroup.visible = false;
            
            const d = PLANET_DATA[index]; document.getElementById('p-name').innerText = d.name; document.getElementById('p-name').style.color = d.pColor; 
            document.getElementById('p-diam').innerText = d.realDia; document.getElementById('p-temp').innerText = d.temp; document.getElementById('p-grav').innerText = d.grav; document.getElementById('p-moons').innerText = d.moons.length > 0 ? d.moons.length + " (Major)" : "None";
            
            panelToggle.style.display = 'flex'; 
            if(isMobile) { exitBtn.style.display = 'flex'; }
            
            if(window.innerWidth > 768) { sidePanel.classList.add('active'); panelToggle.classList.add('open'); } 
            else { sidePanel.classList.remove('active'); panelToggle.classList.remove('open'); }
            STATE.rotationY = 0; STATE.rotationVelocity = 0;
        }

        function exitDetailView() {
            sidePanel.classList.remove('active'); panelToggle.classList.remove('open'); panelToggle.style.display = 'none'; exitBtn.style.display = 'none';
            gsap.delayedCall(0.4, () => {
                gsap.to(STATE, { particleScale: 0, duration: 0.5, ease: "power2.in", onComplete: () => { 
                    STATE.mode = 'SOLAR'; STATE.lastModeChange = Date.now(); document.getElementById('mode-val').innerText = "SYSTEM VIEW"; 
                    particleSystem.visible = false; solarGroup.visible = true; resetSelection(); STATE.isExiting = false;
                }});
            });
        }
        
        function animate() {
            requestAnimationFrame(animate); const time = performance.now() * 0.001;
            if(STATE.mode === 'SOLAR') { solarGroup.rotation.y = Math.sin(time * 0.02) * 0.05; sunParticles.rotation.y -= 0.005; sunMat.uniforms.uTime.value = time; } 
            else { pMat.uniforms.uTime.value = time; pMat.uniforms.uScale.value += (STATE.particleScale - pMat.uniforms.uScale.value) * 0.1; if(!STATE.isDragging) STATE.rotationVelocity *= 0.95; STATE.rotationY += STATE.rotationVelocity; particleSystem.rotation.y = STATE.rotationY; }
            renderer.render(scene, camera);
        }
        
        window.addEventListener('resize', () => { camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
        animate();
    </script>
</body>
</html>
